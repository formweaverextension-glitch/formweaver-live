<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FormWeaver Client Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fv-primary': '#4f46e5',
                        'fv-secondary': '#8b5cf6',
                        'fv-success': '#10b981',
                        'fv-error': '#ef4444',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8 font-sans flex items-center justify-center">
    <div id="app" class="max-w-lg w-full">
        <header class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-fv-primary">
            <h1 id="form-title" class="text-3xl font-bold text-gray-800">FormWeaver Portal</h1>
            <p id="auth-status" class="mt-2 text-sm text-gray-600">Connecting...</p>
        </header>

        <!-- Dynamic Form Section -->
        <main id="form-container" class="bg-white p-6 rounded-xl shadow-lg mt-8 hidden">
            <form id="client-form" class="space-y-4">
                <!-- Fields will be dynamically injected here -->
            </form>
            <button onclick="window.submitClientForm()" class="w-full mt-6 py-2 bg-fv-primary text-white font-semibold rounded-lg hover:bg-fv-secondary transition duration-150 shadow">Submit Information</button>
            <p id="submit-status" class="text-sm text-center mt-4 text-gray-500"></p>
        </main>

        <!-- Access Denied / Loading Section -->
        <div id="message-container" class="bg-white p-6 rounded-xl shadow-lg mt-8 text-center">
            <p id="message-text" class="text-lg font-medium text-gray-700">Validating access, please wait...</p>
        </div>
    </div>

    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // *** UPDATED to include Redirect functions ***
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, getRedirectResult } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL CONSTANTS ---
        const appId = 'formweaver-3d973'; // Hardcoded for deployment
        
        // --- YOUR FIREBASE CONFIG (PRE-INSTALLED) ---
        const firebaseConfig = {
          apiKey: "AIzaSyA4EABADom_6PWYgO1usdvE0ChZslmYD0E",
          authDomain: "formweaver-3d973.firebaseapp.com",
          projectId: "formweaver-3d973",
          storageBucket: "formweaver-3d973.firebasestorage.app",
          messagingSenderId: "353605039501",
          appId: "1:353605039501:web:4c17cd90b8e059bcd179c4",
          measurementId: "G-3R8JYX8T76"
        };
        // -----------------------------------------------------------
        
        // --- YOUR GOOGLE CLOUD API KEY (PRE-INSTALLED) ---
        const API_KEY = 'AIzaSyCi0txEyx_9M593qNiKYEuhYQCyHXj8yZQ'; 

        const LICENSES_PATH = `/artifacts/${appId}/public/data/licenses`;
        const FORMS_PATH = `/artifacts/${appId}/public/data/form_definitions`;
        const SUBMISSIONS_PATH = `/artifacts/${appId}/public/data/form_submissions`;
        const SHEET_ID = '1HHzloz2mXo9CzY6PSYDQCVpPSBkWWRXIRQiAWNmPars9Ec'; // Your Sheet ID

        let db, auth;
        let currentUID = null;
        let clientEmail = null;
        let formId = null;
        const provider = new GoogleAuthProvider();

        // --- UTILITY FUNCTIONS ---
        function log(message, isError = false) {
            console.log(isError ? `[ERROR] ${message}` : `[LOG] ${message}`);
            const statusEl = document.getElementById('auth-status');
            if (statusEl) statusEl.textContent = message;
        }

        function showMessage(message, isError = false) {
            const msgContainer = document.getElementById('message-container');
            const msgText = document.getElementById('message-text');
            const formContainer = document.getElementById('form-container');
            
            msgText.textContent = message;
            msgText.classList.toggle('text-fv-error', isError);
            msgContainer.classList.remove('hidden');
            formContainer.classList.add('hidden');
        }

        // --- CORE APPLICATION LOGIC ---

        // 1. Get Form ID from URL
        function getFormIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('formId');
            if (id) {
                log(`Form ID found in URL: ${id}`);
                return id.replace(/\s/g, '_');
            }
            return null;
        }

        // 2. Check Client License against the Sheet data
        async function checkClientLicense(email) {
            if (!db) {
                log("Database not initialized.", true);
                return { status: "ERROR", message: "Database not connected." };
            }
            
            const range = 'AllowedUsers!A:B'; // Check Email (A) and Expiry (B)
            const sheetsApiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`;

            try {
                const response = await fetch(sheetsApiUrl);
                if (!response.ok) {
                     const errorData = await response.json();
                     console.error("Google Sheets API Error:", errorData);
                     throw new Error(`Google Sheets API error: ${response.status}. Check API Key restrictions and ensure Sheets API is enabled.`);
                }
                const data = await response.json();
                
                if (!data.values) {
                     return { status: "DENIED", message: `Access Denied: No users found in license sheet.` };
                }

                const licenses = data.values;
                // Find email in Column A, case-insensitive
                const userLicense = licenses.find(row => row[0] && row[0].toLowerCase() === email.toLowerCase()); 

                if (!userLicense) {
                    return { status: "DENIED", message: `Access Denied: Email '${email}' not found in license list.` };
                }

                const expiryDate = userLicense[1]; // Get expiry from Column B
                if (expiryDate === "Permanent" || (new Date(expiryDate) && new Date(expiryDate).getTime() > Date.now())) {
                    return { status: "ACTIVE", message: "License confirmed." };
                } else {
                    return { status: "DENIED", message: "Access Denied: Your license has expired." };
                }

            } catch (error) {
                log(`Sheet API Error: ${error.message}.`, true);
                return { status: "ERROR", message: "Could not verify license. Contact administrator." };
            }
        }

        // 3. Fetch the Form Definition from Firebase
        async function fetchFormDefinition(id) {
            const docRef = doc(db, FORMS_PATH, id);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                log(`Form blueprint '${id}' loaded successfully.`);
                return docSnap.data();
            } else {
                log(`Form definition not found: ${id}`, true);
                return null;
            }
        }

        // 4. Render the Form Fields
        function renderForm(formDef) {
            const formContainer = document.getElementById('form-container');
            const clientForm = document.getElementById('client-form');
            const msgContainer = document.getElementById('message-container');
            
            document.getElementById('form-title').textContent = formDef.name;
            clientForm.innerHTML = ''; // Clear previous fields

            formDef.fields.forEach(field => {
                const div = document.createElement('div');
                const label = document.createElement('label');
                label.htmlFor = field.name;
                label.className = "block text-sm font-medium text-gray-700";
                label.textContent = field.label;
                
                let input;
                if (field.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.rows = 4;
                } else {
                    input = document.createElement('input');
                    input.type = field.type;
                }
                
                input.id = field.name;
                input.name = field.name;
                input.className = "w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-fv-primary focus:border-fv-primary";
                
                if (field.name.toLowerCase().includes('email')) {
                    input.value = clientEmail || '';
                }
                if (field.name.toLowerCase().includes('name') && auth.currentUser.displayName) {
                    input.value = auth.currentUser.displayName;
                }

                div.appendChild(label);
                div.appendChild(input);
                clientForm.appendChild(div);
            });

            msgContainer.classList.add('hidden');
            formContainer.classList.remove('hidden');
        }

        // 5. Submit the Form
        window.submitClientForm = async function() {
            const statusEl = document.getElementById('submit-status');
            const formData = new FormData(document.getElementById('client-form'));
            const submissionData = {};
            
            formData.forEach((value, key) => {
                submissionData[key] = value;
            });

            if (Object.keys(submissionData).length === 0) {
                statusEl.textContent = "Form is empty.";
                return;
            }

            // Add metadata
            submissionData.submittedAt = Timestamp.now();
            submissionData.formId = formId;
            submissionData.clientEmail = clientEmail;
            submissionData.clientUID = currentUID;

            try {
                // Create a new document in the submissions collection
                const newSubmissionRef = doc(collection(db, SUBMISSIONS_PATH));
                await setDoc(newSubmissionRef, submissionData);
                
                log("Form submitted successfully!");
                showMessage("Thank you! Your submission has been received.", false);

            } catch (error) {
                log(`Error submitting form: ${error.message}`, true);
                statusEl.textContent = `Submission Error: ${error.message}`;
            }
        }

        // --- RUN INITIALIZATION (*** UPDATED WITH REDIRECT LOOP FIX ***) ---
        async function initializeClientApp() {
            try {
                formId = getFormIdFromUrl();
                if (!formId) {
                    showMessage("Access Denied: No Form ID provided in the URL.", true);
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // This listener handles ALL auth states
                onAuthStateChanged(auth, async (user) => {
                    log("Auth state changed...");
                    if (user) {
                        // User is signed in.
                        currentUID = user.uid;
                        clientEmail = user.email;

                        if (!clientEmail) {
                             // This should rarely happen now, but good to keep as a fallback.
                             log("No email found, forcing Google sign-in...");
                             signInWithRedirect(auth, provider); // <-- THE FIX
                             return;
                        }
                        
                        log(`Authenticated as: ${clientEmail}. Checking license...`);
                        const license = await checkClientLicense(clientEmail); 
                        
                        if (license.status !== "ACTIVE") {
                            showMessage(license.message, true);
                            return;
                        }

                        log("Client license validated. Fetching form blueprint...");
                        const formDef = await fetchFormDefinition(formId);
                        
                        if (formDef) {
                            renderForm(formDef);
                        } else {
                            showMessage(`Error: Form definition '${formId}' could not be found.`, true);
                        }

                    } else {
                        // No user is signed in.
                        // Check if we are coming back FROM a redirect.
                        log("No user found. Checking for redirect result...");
                        try {
                            const result = await getRedirectResult(auth);
                            if (result === null) {
                                // User is not signed in and did NOT just come from a redirect.
                                // This is a new visit. Start the login.
                                log("No redirect result. Starting new Google Sign-in...");
                                signInWithRedirect(auth, provider);
                            }
                            // if (result) is not null, onAuthStateChanged will
                            // fire a *second* time with the (user) object,
                            // and the (user) block above will run. We do nothing here.
                            else {
                                log("Redirect result found. Waiting for auth state to update.");
                            }
                        } catch (error) {
                            log(`Error during getRedirectResult: ${error.message}`, true);
                            // If redirect fails, try one more time.
                            signInWithRedirect(auth, provider);
                        }
                    }
                });

            } catch (error) {
                showMessage(`Critical Error: ${error.message}`, true);
            }
        }

        initializeClientApp();
    </script>
</body>
</html>