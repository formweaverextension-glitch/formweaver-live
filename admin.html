<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FormWeaver Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fv-primary': '#4f46e5',
                        'fv-secondary': '#8b5cf6',
                        'fv-success': '#10b981',
                        'fv-error': '#ef4444',
                    }
                }
            }
        }
    </script>
    <!-- Include the Google API Client Library for Sheets Write Access -->
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8 font-sans">
    <div id="app" class="max-w-4xl mx-auto space-y-8">
        <header class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-fv-primary">
            <h1 class="text-3xl font-bold text-gray-800">FormWeaver Admin Access</h1>
            <p id="auth-status" class="mt-2 text-sm text-gray-600">Connecting...</p>
        </header>

        <!-- Access Required / Manual Sign-in Section -->
        <section id="auth-required" class="bg-white p-6 rounded-xl shadow-lg mt-8 text-center hidden">
            <h3 class="text-xl font-medium text-fv-primary mb-4">Access Required</h3>
            <p class="text-gray-600 mb-6">Please click below to start the Google Sheets authorization process.</p>
            <button id="sign-in-btn" class="w-full max-w-sm py-2 bg-fv-primary text-white font-semibold rounded-lg hover:bg-fv-secondary transition duration-150 shadow">
                Sign In with Google
            </button>
            <p id="auth-message" class="text-sm text-center mt-4 text-gray-500">&nbsp;</p>
        </section>

        <!-- License Management Section -->
        <section id="license-management" class="bg-white p-6 rounded-xl shadow-lg space-y-6">
            <h2 class="text-2xl font-semibold text-fv-primary border-b pb-2">License Management</h2>
            <div id="user-info" class="space-y-2 text-sm">
                <p><strong>Admin Email:</strong> <span id="email-display" class="text-gray-600">---</span></p>
                <p><strong>License Status:</strong> <span id="status-badge" class="font-bold px-2 py-1 rounded-full text-white bg-gray-500">CHECKING</span></p>
                <p><strong>Expiration:</strong> <span id="expiry-date" class="text-gray-600">---</span></p>
            </div>

            <div id="admin-panel" class="hidden space-y-4">
                <h3 class="text-xl font-medium">Grant/Revoke Access</h3>
                <input type="email" id="target-email" placeholder="Client Email Address" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-fv-primary focus:border-fv-primary">
                
                <select id="access-type" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-fv-primary focus:border-fv-primary">
                    <option value="trial">2-Day Free Trial</option>
                    <option value="monthly">Monthly Subscription (End of Month)</option>
                    <option value="permanent">Permanent Access</option>
                    <option value="revoke">Revoke Access (Set Expired)</option>
                </select>
                
                <button onclick="window.grantAccess()" class="w-full py-2 bg-fv-primary text-white font-semibold rounded-lg hover:bg-fv-secondary transition duration-150 shadow">Update Access</button>

                <p id="link-display" class="pt-4 text-center text-sm break-all">
                    Master Client Link: <br>
                    <a href="index.html?formId=Client_Contact_Info" id="client-link" class="text-blue-600 hover:underline">Loading...</a>
                </p>
                <button onclick="window.copyLink()" class="w-full py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">Copy Client Link</button>
            </div>
            <p id="admin-message" class="text-sm text-center mt-2">&nbsp;</p>
        </section>

        <!-- Form Builder Section -->
        <section id="form-builder" class="bg-white p-6 rounded-xl shadow-lg space-y-4">
            <h2 class="text-2xl font-semibold text-fv-primary border-b pb-2">Form Blueprint Setup</h2>
            <input type="text" id="form-name" value="Client Contact Info" readonly class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50">
            <textarea id="form-fields" class="w-full p-2 border border-gray-300 rounded-lg h-24 focus:ring-fv-primary focus:border-fv-primary">Client Full Name, Email Address, Phone Number</textarea>
            <button onclick="window.saveFormDefinition()" class="w-full py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 shadow">Save Form Definition</button>
            <p id="form-save-status" class="text-sm text-gray-500"></p>
        </section>

        <!-- Submissions Dashboard Section -->
        <section id="submissions-dashboard" class="bg-white p-6 rounded-xl shadow-lg space-y-4 hidden">
            <h2 class="text-2xl font-semibold text-fv-primary border-b pb-2">Client Submissions</h2>
            <div class="max-h-96 overflow-y-auto shadow ring-1 ring-black ring-opacity-5 rounded-lg">
                <table class="min-w-full divide-y divide-gray-300">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Submitted At</th>
                            <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Email</th>
                            <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Name</th>
                            <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Phone</th>
                        </tr>
                    </thead>
                    <tbody id="submissions-body" class="divide-y divide-gray-200 bg-white">
                        <!-- Submission rows will be injected here -->
                        <tr><td colspan="4" class="p-4 text-center text-gray-500">Loading submissions...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Firebase and Sheets Libraries -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            // --- FIXED: Ensures all necessary auth components are imported ---
            import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, getRedirectResult } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, doc, getDoc, setDoc, Timestamp, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
            
            // --- Sheets Write Scope ---
            const SHEETS_WRITE_SCOPE = 'https://www.googleapis.com/auth/spreadsheets';
            
            const firebaseConfig = {
              apiKey: "AIzaSyA4EABADom_6PWYgO1usdvE0ChZslmYD0E",
              authDomain: "formweaver-3d973.firebaseapp.com",
              projectId: "formweaver-3d973",
              storageBucket: "formweaver-3d973.firebasestorage.app",
              messagingSenderId: "353605039501",
              appId: "1:353605039501:web:4c17cd90b8e059bcd179c4",
              measurementId: "G-3R8JYX8T76"
            };

            const appId = 'formweaver-3d973';
            const FORM_DEFINITIONS_PATH = `/artifacts/${appId}/public/data/form_definitions`;
            const SUBMISSIONS_PATH = `/artifacts/${appId}/public/data/form_submissions`;
            
            // --- FINAL CORRECT SHEET ID ---
            const SHEET_ID = '1rEHzIoz3mXogcq76PSYDOvPS0bKlWWXIRQawmPsrs9E';
            const API_KEY = 'AIzaSyCi0txEyx_9M593qNiKYEuhYQCyHXj8yZQ'; 
            const RANGE = 'AllowedUsers!A:C'; 

            let db, auth;
            let currentUID = null;
            const provider = new GoogleAuthProvider();
            
            let googleApiAuthToken = null;
            
            // Initialize gapi client on window load
            window.onload = function() {
                if (typeof gapi !== 'undefined') {
                    gapi.load('client', () => {
                        console.log("[LOG] Google API Client loaded.");
                    });
                }
                // Attach event listener for the manual sign-in button
                document.getElementById('sign-in-btn')?.addEventListener('click', signInForSheets);
            };

            async function signInForSheets() {
                log("Starting Google Sign-in with REDIRECT...");
                provider.addScope(SHEETS_WRITE_SCOPE); 
                // --- FIXED: Use signInWithRedirect ---
                signInWithRedirect(auth, provider);
            }

            function log(message, isError = false) {
                const statusElement = document.getElementById('auth-status');
                const logMessage = isError ? `[ERROR] ${message}` : `[LOG] ${message}`;
                console.log(logMessage);
                if (statusElement) {
                    statusElement.textContent = logMessage;
                    statusElement.classList.remove('text-gray-600', 'text-fv-error');
                    statusElement.classList.add(isError ? 'text-fv-error' : 'text-fv-primary');
                }
            }
            
            function showMessage(elementId, message, isError = false) {
                 const el = document.getElementById(elementId);
                 if (!el) return;
                 el.textContent = message;
                 el.classList.remove('hidden', 'text-fv-error', 'text-fv-success');
                 if (isError) {
                     el.classList.add('text-fv-error');
                 } else {
                     el.classList.add('text-fv-success');
                 }
                 setTimeout(() => {
                    if (el.textContent === message) {
                        el.textContent = '\u00A0';
                    }
                 }, 3000);
            }

            async function checkAdminLicense(email) {
                if (!email) return { status: "ERROR", role: "None", expires: "N/A", message: "No email provided." };
                log(`Checking admin license for ${email} in Google Sheet...`);
                
                const sheetsApiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(RANGE)}?key=${API_KEY}`;
                
                try {
                    const response = await fetch(sheetsApiUrl);
                    if (!response.ok) {
                         const errorData = await response.json();
                         console.error("Google Sheets API Error:", errorData);
                         throw new Error(`Google Sheets API error: ${response.status} ${response.statusText}. Check SHEET_ID, range, and sheet sharing.`);
                    }
                    const data = await response.json();
                    
                    if (!data.values || data.values.length <= 1) {
                         return { status: "DENIED", role: "None", expires: "N/A", message: `Access Denied: Email '${email}' not found (sheet empty or header only).` };
                    }
                    
                    const licenses = data.values.slice(1); // Skip header row
                    const adminLicense = licenses.find(row => row[0] && row[0].toLowerCase() === email.toLowerCase()); 
                    
                    if (!adminLicense) {
                        return { status: "DENIED", role: "None", expires: "N/A", message: `Access Denied: Email '${email}' not found in sheet.` };
                    }
                    const expiryDate = adminLicense[1];
                    const role = adminLicense[2] || "User";
                    const expiresText = expiryDate || "N/A";
                    
                    if (expiryDate === "Permanent" || (new Date(expiryDate) && new Date(expiryDate).getTime() > Date.now())) {
                        if (role.toLowerCase() === 'admin') {
                            log("Admin license ACTIVE.");
                            return { status: "ACTIVE", role: "admin", expires: expiresText, message: "Admin access granted." };
                        } else {
                            log("Active user license found, but NOT admin.", true);
                            return { status: "ACTIVE", role: "User", expires: expiresText, message: "Access Denied: You are not an admin." };
                        }
                    } else {
                        log("License found, but it is EXPIRED.", true);
                        return { status: "EXPIRED", role: role, expires: expiresText, message: "Access Denied: Your license is expired." };
                    }
                } catch (error) {
                    log(`Sheet API Error: ${error.message}.`, true);
                    return { status: "ERROR", role: "None", expires: "N/A", message: "Could not verify license. Contact administrator." };
                }
            }

            function setupSubmissionListener() {
                const dashboardEl = document.getElementById('submissions-dashboard');
                const submissionsBody = document.getElementById('submissions-body');
                
                dashboardEl.classList.remove('hidden');

                const q = query(collection(db, SUBMISSIONS_PATH));

                onSnapshot(q, (querySnapshot) => {
                    let submissionsHtml = '';
                    const submissions = [];

                    querySnapshot.forEach((doc) => {
                        submissions.push(doc.data());
                    });

                    submissions.sort((a, b) => {
                        const timeA = a.submittedAt instanceof Timestamp ? a.submittedAt.toMillis() : 0;
                        const timeB = b.submittedAt instanceof Timestamp ? b.submittedAt.toMillis() : 0;
                        return timeB - timeA;
                    });

                    if (submissions.length === 0) {
                        submissionsHtml = '<tr><td colspan="4" class="p-4 text-center text-gray-500">No submissions yet.</td></tr>';
                    } else {
                        submissions.forEach(data => {
                            const name = data['Client_Full_Name'] || data['ClientFullName'] || 'N/A';
                            const email = data['Email_Address'] || data['ClientEmail'] || 'N/A';
                            const phone = data['Phone_Number'] || data['PhoneNumber'] || 'N/A';
                            
                            let submittedDate = 'N/A';
                            if (data.submittedAt instanceof Timestamp) {
                                submittedDate = data.submittedAt.toDate().toLocaleString();
                            }
                            
                            submissionsHtml += `
                                <tr class="hover:bg-gray-100">
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${submittedDate}</td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm font-medium text-gray-900">${email}</td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${name}</td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${phone}</td>
                                </tr>
                            `;
                        });
                    }

                    submissionsBody.innerHTML = submissionsHtml;
                    log(`Loaded ${submissions.length} client submissions.`);
                });
            }

            function updateAdminUI(license, email) {
                const statusBadge = document.getElementById('status-badge');
                const adminPanel = document.getElementById('admin-panel');
                const expiryDate = document.getElementById('expiry-date');
                const authRequiredEl = document.getElementById('auth-required');
                
                authRequiredEl.classList.add('hidden'); // Hide the sign-in prompt
                statusBadge.textContent = license.status;
                expiryDate.textContent = license.expires;
                document.getElementById('email-display').textContent = email || '---';
                statusBadge.className = 'font-bold px-2 py-1 rounded-full text-white';
                
                if (license.status === 'ACTIVE' && license.role === 'admin') {
                    statusBadge.classList.add('bg-fv-success');
                    adminPanel.classList.remove('hidden');
                    log("Admin UI unlocked.");
                    setupSubmissionListener(); 
                } else {
                    statusBadge.classList.add(license.status === 'EXPIRED' ? 'bg-fv-error' : 'bg-gray-500');
                    showMessage('admin-message', license.message || "Access Denied: You do not have an active admin license.", true);
                    log(`Admin UI locked. Reason: ${license.message}`);
                }
            }

            function calculateExpirationDate(type) {
                const today = new Date();
                if (type === 'permanent') return 'Permanent';
                
                const expiryDate = new Date(today);
                if (type === 'monthly') {
                    expiryDate.setDate(1); 
                    expiryDate.setMonth(expiryDate.getMonth() + 2); 
                    expiryDate.setDate(0); 
                } else if (type === 'trial') {
                    expiryDate.setDate(today.getDate() + 2);
                } else if (type === 'revoke') {
                     return 'Expired';
                }
                return expiryDate.toISOString().split('T')[0];
            }
            
            // --- Sheets API Helper Functions ---
            async function findClientRow(email) {
                const sheetsApiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(RANGE)}?key=${API_KEY}`;
                
                const response = await fetch(sheetsApiUrl); // Read only, so no token needed here
                
                if (!response.ok) throw new Error(`API Read Error: ${response.statusText}`);
                
                const data = await response.json();
                const rows = data.values || [];
                
                for (let i = 1; i < rows.length; i++) {
                    if ((rows[i][0] || '').toLowerCase() === email.toLowerCase()) {
                        return i + 1; 
                    }
                }
                return null;
            }

            async function updateSheet(email, newExpiry, newRole, rowIndex) {
                const updateRange = `AllowedUsers!B${rowIndex}:C${rowIndex}`;
                const updateBody = {
                    values: [[newExpiry, newRole]],
                    majorDimension: "ROWS"
                };
                const sheetsApiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${updateRange}?valueInputOption=USER_ENTERED`;
                
                const response = await fetch(sheetsApiUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${googleApiAuthToken}`
                    },
                    body: JSON.stringify(updateBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Sheet Write Error: ${errorData.error?.message || response.statusText}`);
                }
            }


            window.grantAccess = async function() {
                const statusEl = document.getElementById('admin-message');
                const email = document.getElementById('target-email').value.trim();
                const accessType = document.getElementById('access-type').value;
                statusEl.textContent = 'Processing...';

                if (!email) { 
                    showMessage('admin-message', "Please enter an email address.", true);
                    return; 
                }
                if (!googleApiAuthToken) {
                     showMessage('admin-message', "ERROR: Admin needs to sign in with Sheets write permission first. Reload.", true);
                     return;
                }

                try {
                    const existingRowIndex = await findClientRow(email);
                    
                    const newExpiry = calculateExpirationDate(accessType);
                    const newRole = accessType === 'revoke' ? 'Expired' : 'User';

                    if (existingRowIndex) {
                        await updateSheet(email, newExpiry, newRole, existingRowIndex);
                        showMessage('admin-message', `SUCCESS: Updated ${email} in Row ${existingRowIndex} with Expiry: ${newExpiry}.`, false);
                    } else {
                        const appendRange = 'AllowedUsers!A:C';
                        const appendBody = {
                            values: [[email, newExpiry, newRole]],
                            majorDimension: "ROWS"
                        };
                        
                        const appendUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${appendRange}:append?valueInputOption=USER_ENTERED`;
                        
                        const response = await fetch(appendUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${googleApiAuthToken}`
                            },
                            body: JSON.stringify(appendBody)
                        });

                        if (!response.ok) throw new Error(`Append Error: ${response.statusText}`);
                        
                        showMessage('admin-message', `SUCCESS: Added new user ${email} with Expiry: ${newExpiry}.`, false);
                    }
                    
                    document.getElementById('target-email').value = '';
                } catch (error) {
                    log(`Error granting access: ${error.message}`, true);
                    showMessage('admin-message', `Sheet Update Error: ${error.message}`, true);
                }
            }

            // (saveFormDefinition and copyLink logic remain the same)
            window.saveFormDefinition = async function() {
                const formNameInput = document.getElementById('form-name');
                const fieldsString = document.getElementById('form-fields').value;
                const statusEl = document.getElementById('form-save-status');
                const formName = formNameInput.value.replace(/\s/g, '_');
                const fields = fieldsString.split(',').map(f => f.trim()).filter(f => f.length > 0);
                if (!formName || fields.length === 0) {
                    statusEl.textContent = "Form name or fields cannot be empty.";
                    return;
                }
                const fieldsSchema = fields.map(field => ({ name: field.replace(/\s/g, '_'), type: "text", label: field }));
                try {
                    const docRef = doc(db, FORM_DEFINITIONS_PATH, formName);
                    await setDoc(docRef, {
                        name: formNameInput.value,
                        fields: fieldsSchema,
                        last_updated: Timestamp.now()
                    });
                    statusEl.textContent = `Form definition '${formNameInput.value}' saved to Firebase successfully.`;
                    log(`Form definition saved: ${formName}`);
                } catch (error) {
                    log(`Error saving form definition: ${error.message}`, true);
                    statusEl.textContent = `Error saving form: ${error.message}`;
                }
            }
            
            function generateClientLink(uid, formName) {
                const baseUrl = window.location.origin + window.location.pathname.replace('admin.html', '');
                const link = `${baseUrl}index.html?formId=${formName}`;
                const linkEl = document.getElementById('client-link');
                linkEl.href = link;
                linkEl.textContent = link;
                log(`Unique Client Access Link Generated: ${link}`);
            }

            window.copyLink = function() {
                const link = document.getElementById('client-link').href;
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = link;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showMessage('admin-message', "Client link copied to clipboard!", false);
                } catch (err) {
                    log('Failed to copy link. Please copy manually.', true);
                }
            }
            // --- CORE APP INIT ---
            async function initializeAppCore() {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    // 1. Process sign-in result (from redirect/popup return)
                    try {
                        const result = await getRedirectResult(auth); 
                        if (result?.user) {
                            const cred = GoogleAuthProvider.credentialFromResult(result);
                            googleApiAuthToken = cred?.accessToken ?? null;
                            log("[LOG] Captured Sheets OAuth Token.");
                        }
                    } catch (e) {
                         log(`getRedirectResult error: ${e.code || e.message}`, true);
                    }

                    onAuthStateChanged(auth, async (user) => {
                        const authRequiredEl = document.getElementById('auth-required');
                        if (user) {
                            currentUID = user.uid;
                            log(`User authenticated: ${user.email}`);
                            
                            // If we have a Firebase session but NO Sheets token, force the popup sign-in
                            if (!googleApiAuthToken) {
                                log("Token missing. Starting sign-in with Sheets scope (POPUP).");
                                provider.addScope(SHEETS_WRITE_SCOPE); 
                                signInWithPopup(auth, provider).then((result) => {
                                    const cred = GoogleAuthProvider.credentialFromResult(result);
                                    googleApiAuthToken = cred?.accessToken ?? null;
                                    log("[LOG] Captured Sheets OAuth Token after POPUP.");
                                    // Let onAuthStateChanged run again with the token
                                }).catch((error) => {
                                    log(`Sign-in Failed: ${error.code || error.message}`, true);
                                    // Fallback to display the manual button if popup fails
                                    authRequiredEl.classList.remove('hidden');
                                    document.getElementById('status-badge').textContent = '---';
                                    log("User is not authenticated. Showing manual login button.");
                                });
                                return; 
                            }
                            
                            // If we have both (user signed in AND the token): run checks and unlock UI
                            const license = await checkAdminLicense(user.email);
                            updateAdminUI(license, user.email);
                            
                            if (license.status === 'ACTIVE' && license.role === 'admin') {
                                generateClientLink(currentUID, 'Client_Contact_Info');
                            }
                        } else {
                            // If user is not signed in at all, display manual sign-in button
                            authRequiredEl.classList.remove('hidden');
                            document.getElementById('status-badge').textContent = '---';
                            log("User is not authenticated. Showing manual login button.");
                        }
                    });
                } catch (error) {
                    log(`Critical Initialization Error: ${error.message}`, true);
                }
            }
            
            initializeAppCore();
        </script>
    </div>
</body>
</html>
